const {
  default: makeWASocket,
  DisconnectReason,
  useMultiFileAuthState,
  fetchLatestBaileysVersion,
  isJidBroadcast,
  isJidStatusBroadcast,
  isJidNewsletter,
} = require("baileys");

const pino = require("pino");
const fs = require("fs");
const readline = require("readline");
const { runLite } = require("./index"); // Usa la lÃ³gica original para los comandos

const SESSION_DIR = "./session";
if (!fs.existsSync(SESSION_DIR)) fs.mkdirSync(SESSION_DIR, { recursive: true });

let botReady = false; // Para evitar que procese mensajes antes de estar listo

async function askQuestion(question) {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });
  return new Promise((resolve) => rl.question(question, (ans) => {
    rl.close();
    resolve(ans.trim());
  }));
}

async function startBot() {
  console.log("ğŸš€ Iniciando bot...");

  const { state, saveCreds } = await useMultiFileAuthState(SESSION_DIR);
  const { version } = await fetchLatestBaileysVersion();

  const socket = makeWASocket({
    version,
    logger: pino({ level: "silent" }),
    auth: state,
    keepAliveIntervalMs: 60 * 1000,
    shouldIgnoreJid: (jid) =>
      isJidBroadcast(jid) || isJidStatusBroadcast(jid) || isJidNewsletter(jid),
  });

  if (!socket.authState.creds.registered) {
    console.log("ğŸ“± No hay sesiÃ³n guardada. Se requiere vinculaciÃ³n.");
    const phoneNumber = await askQuestion("ğŸ“ Ingresa tu nÃºmero de WhatsApp (ej: 5491123456789): ");

    if (!phoneNumber) {
      console.error("âŒ NÃºmero invÃ¡lido. Reinicia el bot e intenta nuevamente.");
      process.exit(1);
    }

    const code = await socket.requestPairingCode(phoneNumber);
    console.log(`âœ… CÃ³digo de vinculaciÃ³n enviado: ${code}`);
  }

  socket.ev.on("creds.update", saveCreds);

  socket.ev.on("connection.update", (update) => {
    const { connection, lastDisconnect } = update;

    if (connection === "close") {
      const reason = lastDisconnect?.error?.output?.statusCode;
      if (reason === DisconnectReason.loggedOut) {
        console.error("âŒ Se eliminÃ³ la sesiÃ³n. Reinicia para vincular nuevamente.");
        process.exit(1);
      } else {
        console.log("ğŸ”„ Reconectando...");
        startBot();
      }
    } else if (connection === "open") {
      console.log("âœ… Bot conectado exitosamente.");
      
      // Espera unos segundos antes de procesar comandos para evitar la carga lenta
      setTimeout(() => {
        botReady = true;
        console.log("ğŸ“© Bot listo para recibir comandos.");
      }, 3000);
    }
  });

  socket.ev.on("messages.upsert", (data) => {
    if (!botReady) return; // Evita procesar mensajes antes de que el bot estÃ© listo
  
    runLite({ socket, data });
  });

  return socket;
}

startBot();